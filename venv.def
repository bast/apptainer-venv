Bootstrap: docker
From: alpine:latest


%post
    apk update

    apk add curl python3 bash
    curl -LsSf https://astral.sh/uv/install.sh | sh

    # clean up
    rm -rf /var/cache/apk/*


%runscript
    export PATH=$PATH:/root/.cargo/bin

    # change shell to bash
    SHELL=/bin/bash

    if [ ! -d "venv" ]; then
        uv venv venv
        source venv/bin/activate
        uv pip install -r requirements.txt
    else
        source venv/bin/activate
        if [ "requirements.txt" -nt "venv" ]; then
          echo "requirements.txt is newer than venv: updating venv"
          uv pip install -r requirements.txt
          touch venv
      fi
    fi

    $@


%help
    Reads:
        requirements.txt

    Creates:
        venv

    Usage:
        $ ./venv.sif python myscript.py
        runs myscript.py inside the virtual environment defined by requirements.txt

        $ ./venv.sif python
        opens python shell inside the virtual environment defined by requirements.txt
